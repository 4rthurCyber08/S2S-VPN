# Certificates

## CA Hierarchy

1. ROOT CA
   - X509v3
   - Basic Constraints [Critical]
       CA
   - Key Usage [Critical]
       Certificate Sign
       CRL Sign

<br>

2. SUB CA
   - X509v3
   - Basic Constraints [Critical]
       CA
	   Path Len: 0
   - Key Usage [Critical]
       Certificate Sign
       CRL Sign

<br>

3. LEAF CA
   - X509v3
   - Basic Constraints [Critical]
       END-ENTITY
   - Extensions
       Subject Alt Names
   - Key Usage [Critical]
       Digital Signature
	   Key Encipherment
	   Data Encipherment
	   Key Agreement
   - Extended Key Usage
       TLS Web Server Authentication
       TLS Web Client Authentication	   
	   E-mail Protection
	   IPSec End System
	   IPSec Tunnel
	   IPSec User
	   IP Security end entity


<br>
<br>

---
&nbsp; 


## Certificates via OPENSSL

### STEP 1. Create a self-signed cert on linux using openssl. 

> __GENERATE PRIVATE KEY__

<br>

__ROOTCA__
~~~
!@NetOps
openssl genrsa -aes256 -out netops-ca.key 2048
~~~

<br>

__SUBCA__
~~~
!@NetOps
openssl genrsa -aes256 -out netops-subca.key 2048
~~~


<br>


or (via Windows)


<br>


__LEAFCERT__
~~~
!@Powershell
$ca = New-SelfSignedCertificate `
  -Subject "CN=RivanCyber Institute CEBU, O=Rivancorp, OU=ICT, L=Cebu, ST=Central Visayas, C=PH" `
  -DnsName "ns.rivancorp.com" `
  -KeyAlgorithm RSA `
  -KeyLength 2048 `
  -HashAlgorithm SHA256 `
  -KeyUsage  KeyEncipherment, DataEncipherment, DigitalSignature  `
  -CertStoreLocation "Cert:\LocalMachine\My" `
  -TextExtension @(
    "2.5.29.19={text}ca=false" `
    ,"2.5.29.37={text}1.3.6.1.5.5.7.3.1"
  ) `
  -NotAfter (Get-Date).AddYears(10)
~~~

<br>

__Text Extension values__

| SERVICE        | EKU OIDs          | Purpose            |
| ---            | ---               | ---                |
| HTTPS / FTPS   | 1.3.6.1.5.5.7.3.1 | Server Auth        |
| Client Auth    | 1.3.6.1.5.5.7.3.2 | Client Auth        |
| IPsec VPN      | 1.3.6.1.5.5.7.3.5 | IPsec End System   |
| Email (S/MIME) | 1.3.6.1.5.5.7.3.4 | Email Protection   |
| Code Signing   | 1.3.6.1.5.5.7.3.3 | Code Signing       |


<br>

~~~
!@NetOps
cd /certs
ftp [IP Address]
ftp> binary
ftp> get win.pfx
~~~

> Create an OPENSSL configuration file to support Subject Alt Names

~~~
!@NetOps
nano ca.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_ca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = Admin
CN = Rivancorp Root CA

[ v3_ca ]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash

[v3_subca]
basicConstraints = critical, CA:true
keyUsage = critical, keyCertSign, cRLSign
subjectKeyIdentifier = hash
authorityKeyIdentifier = keyid,issuer
~~~


<br>

~~~
!@NetOps
nano subca.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_subca
prompt             = no
default_md         = sha256

[ req_distinguished_name ]
C  = PH
ST = NCR
L  = Manila
O  = Rivancorp
OU = IT Department
CN = Rivancorp SubCA

[ v3_subca ]
basicConstraints = critical, CA:true, pathlen:0
keyUsage = critical, keyCertSign, cRLSign
~~~


<br>


~~~
!@NetOps
nano win.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = ICT
CN = www.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = www.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.200
~~~


<br>


> OUTPUT SELF-SIGNED CA

~~~
!@NetOps
openssl req \
-new -x509 \
-key netops-ca.key \
-out netops-ca.crt \
-days 365 \
-extensions v3_ca \
-config ca.cnf
~~~


<br>


> CREATE A CSR FOR THE SUBCA USING THE SELFSIGNED CA

~~~
!@NetOps
openssl req -new \
-key netops-subca.key \
-out netops-subca.csr \
-config subca.cnf \
-extensions v3_subca
~~~


<br>


> SIGN THE SUBCA CSR USING THE SELFSIGNED CA

~~~
!@NetOps
openssl x509 -req \
-in netops-subca.csr \
-CA netops-ca.crt \
-CAkey netops-ca.key \
-CAcreateserial \
-out netops-subca.crt \
-days 3650 \
-extfile ca.cnf \
-extensions v3_subca \
-copy_extensions copy
~~~


<br>
<br>

---
&nbsp; 


### STEP 2. Generate then sign the CSR for the client

*IF PFX WAS GENERATED BY WINDOWS*

> OUTPUT THE PRIVATE KEY

~~~
!@NetOps
openssl pkcs12 -in win.pfx -nocerts -out win.key -nodes
~~~


<br>


> EXPORT THE CERTIFICATE

~~~
!@NetOps
openssl pkcs12 -in win.pfx -nokeys -out win.crt
~~~


<br>


> GENERATE A CERTIFICATE SIGNING REQUEST

~~~
!@NetOps
openssl req -new \
-key win.key \
-out win.csr \
-config win.cnf \
-extensions v3_leaf
~~~


> SIGN THE CSR

~~~
!@NetOps
nano win-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = www.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.200
~~~


~~~
!@NetOps
openssl x509 -req \
  -in win.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-win.pem \
  -days 365 \
  -extfile win-ext.cnf \
  -extensions v3_leaf
~~~


<br>
<br>

---
&nbsp; 


### STEP 3. Convert the granted certificate to PFX format

> CONVERT PEM TO PFX

~~~
!@NetOps
openssl pkcs12 -export \
-in grant-win.pem \
-inkey win.key \
-out grant-win.pfx
~~~


<br>
<br>

---
&nbsp; 


### STEP 4. Transfer the CA & Granted Certificate to Windows.

> ENABLE FTP ON WINDOWS SERVER


<br>


> TRANSFER FILES VIA FTP - NOTE: Make sure PFX files are transferred in Binary NOT ASCII

~~~
!@NetOps
cd /certs
ftp [IP]

ftp> put netops-ca.crt
ftp> binary
ftp> put grant-win.pfx
~~~


<br>
<br>

---
&nbsp; 


### STEP 5. Install the Granted Certificates on Windows IIS

> ADD THE CA (netops.crt) to the Trusted Root Certification Authorities

> INSTALL THE GRANTED CERT (grant-win.pfx) in IIS Manager


<br>
<br>

---
&nbsp; 


## SSL CERTIFICATE

> Setup FTP with SSL Certificate


<br>


> CREATE ANOTHER SIGNED CERT FOR LINUX

~~~
!@NetOps
nano linux.cnf
~~~


~~~
[ req ]
default_bits       = 2048
distinguished_name = req_distinguished_name
x509_extensions    = v3_leaf
prompt             = no

[ req_distinguished_name ]
C  = PH
ST = Central Visayas
L  = Cebu
O  = Rivancorp
OU = FTP
CN = ftp.rivancorp.com

[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1   = ftp.rivancorp.com
DNS.2   = rivancorp.com
IP.1    = 192.168.102.10
~~~


<br>


> GENERATE A CERTIFICATE SIGNING REQUEST

~~~
!@NetOps
openssl req -new \
-key netops-ca.key \
-out linux.csr \
-config linux.cnf \
-extensions v3_leaf
~~~


<br>


> SIGN THE CSR

~~~
!@NetOps
nano linux-ext.cnf
~~~


~~~
[ v3_leaf ]
basicConstraints = critical, CA:false
keyUsage = critical, digitalSignature, keyEncipherment
extendedKeyUsage = serverAuth, clientAuth
subjectAltName = @alt_names

[ alt_names ]
DNS.1 = ftp.rivancorp.com
DNS.2 = rivancorp.com
IP.1  = 192.168.102.10
~~~


~~~
!@NetOps
openssl x509 -req \
  -in linux.csr \
  -CA netops-subca.crt \
  -CAkey netops-subca.key \
  -CAcreateserial \
  -out grant-linux.pem \
  -days 365 \
  -extfile linux-ext.cnf \
  -extensions v3_leaf
~~~



### STEP 1. Install lftp

~~~
!@NetOps
sudo yum install lftp
~~~


<br>
<br>

---
&nbsp; 


### STEP 2. Access Windows FTP Server

!@NetOps
cd /certs
cat netops-ca.crt netops-subca.crt grant-linux.pem > fullchain.pem
lftp -u administrator [IP ADDRESS]
set ssl:ca-file fullchain.pem
set ftp:ssl-force true
set ftp:ssl-protect-data true

















MANAGING CAs = Cisco


!@Cisco
conf t
 ip domain name RIVANPH.COM
 end
 
 
!@Cisco
conf t
 crypto pki trustpoint RIVAN-CA
  enrollment terminal
  revocation-check crl none
  exit
 !
 crypto pki authenticate RIVAN-CA



Use the SUBCA to Authenticate Leaf Certs



Generate CSR on Cisco
!@Cisco
conf t
 crypto pki trustpoint RIVANPH
  enrollment terminal
  exit
 !
 crypto pki enroll RIVANPH
 crypto pki authenticate RIVANPH




PEM Header & Footer
-----BEGIN CERTIFICATE REQUEST-----

-----END CERTIFICATE REQUEST-----



Import the Signed CSR
!@Cisco
conf t
 crypto pki import RIVANPH certificate
 end
 
 
 
 
*************






_____________________
********************* Configure GRE over IPSec via Certificate Authentication

1. GRE Tunnel

!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.1 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.12
  tunnel mode gre ip
  end

!@VPN-PH
conf t
 int tun1
  ip add 172.16.10.2 255.255.255.0
  tunnel source g1
  tunnel destination 208.8.8.11
  tunnel mode gre ip
  end


2. Routing Interesting traffic

!@VPN-PH
conf t
 ip route 20.20.20.48 255.255.255.248 172.16.10.2
 end
 
!@VPN-JP
conf t
 ip route 10.10.10.32 255.255.255.224 172.16.10.1
 end


3. Configure ISAKMP Policy

!@VPN-PH, VPN-JP
conf t
 crypto isakmp policy 1
  authentication rsa-sig
  encryption aes 256
  hash sha512
  group 14
  end


4. Configure IPSec Profile

!@VPN-PH, VPN-JP
conf t
 crypto ipsec transform-set IPSECTUNNEL esp-aes 256 esp-sha-hmac
  mode transport
  exit
 crypto ipsec profile RIVAN
  set transform-set IPSECTUNNEL
  set pfs group14
  end


5 Apply IPSec Profile Protection to Tunnel

!@VPN-PH, VPN-JP
conf t
 int tunnel 1
  tunnel protection ipsec profile RIVAN 
  end


_____________________
********************* Verification

!@VPN-PH, VPN-JP
show crypto isakmp sa
show crypto ipsec sa